#!/usr/bin/env python3
import os
import json
from datetime import datetime, timezone
import random

# -------------------------------
# CONFIGURATION
# -------------------------------
LAST_VIDEO_FILE = os.path.expanduser("~/mysite_dashboard/last_posted_video_id.txt")
LOG_FILE = os.path.expanduser("~/mysite_dashboard/cleanup.log")

# Predefined smart reply templates
REPLY_TEMPLATES = [
    "Thanks for watching! üôè",
    "Appreciate your support! üöÄ",
    "You're awesome! üòé",
    "Much love! ‚ù§Ô∏è",
    "Glad you enjoyed it! üéâ",
]

# -------------------------------
# HELPER FUNCTIONS
# -------------------------------
def log(msg):
    timestamp = datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M:%S %Z")
    with open(LOG_FILE, "a") as f:
        f.write(f"[{timestamp}] {msg}\n")
    print(msg)

def get_last_posted_video():
    if not os.path.exists(LAST_VIDEO_FILE):
        return None
    with open(LAST_VIDEO_FILE, "r") as f:
        return f.read().strip()

def get_video_comments(video_id):
    """
    Placeholder for fetching comments from TikTok API.
    Returns a list of comment IDs and text.
    """
    # Example mock comments for demo
    return [
        {"id": "c1", "text": "Love it!"},
        {"id": "c2", "text": "Amazing video!"},
        {"id": "c3", "text": "Keep posting!"},
    ]

def like_comment(video_id, comment_id):
    log(f"[SMART ENGAGE] Liked comment '{comment_id}' on video {video_id}")

def reply_comment(video_id, comment_id, reply_text):
    log(f"[SMART ENGAGE] Replied to '{comment_id}' on video {video_id}: {reply_text}")

def pin_comment(video_id, comment_id):
    log(f"[SMART ENGAGE] Pinned comment '{comment_id}' on video {video_id}")

# -------------------------------
# MAIN ENGAGEMENT FUNCTION
# -------------------------------
def run_smart_engagement():
    video_id = get_last_posted_video()
    if not video_id:
        log("[SMART ENGAGE] No last posted video found. Skipping engagement.")
        return

    log(f"[ENGAGE] Starting smart engagement run @ {datetime.now(timezone.utc)} UTC")

    comments = get_video_comments(video_id)
    likes_count = 0
    replies_count = 0
    pinned = False

    for comment in comments:
        comment_id = comment["id"]
        # Like every comment randomly (70% chance)
        if random.random() < 0.7:
            like_comment(video_id, comment_id)
            likes_count += 1

        # Reply with a smart template randomly (50% chance)
        if random.random() < 0.5:
            reply_text = random.choice(REPLY_TEMPLATES)
            reply_comment(video_id, comment_id, reply_text)
            replies_count += 1

    # Pin the first positive comment (for demo purposes)
    if comments:
        pin_comment(video_id, comments[0]["id"])
        pinned = True

    log(f"[ENGAGE] Finished smart engagement run @ {datetime.now(timezone.utc)} UTC | likes={likes_count}, replies={replies_count}, pinned={pinned}")

# -------------------------------
# RUN
# -------------------------------
if __name__ == "__main__":
    run_smart_engagement()
